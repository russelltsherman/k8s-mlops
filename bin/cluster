#!/usr/bin/env bash

ACTION=${1:-"create"}
PROJECT_ROOT=$(git rev-parse --show-toplevel)

case $ACTION in
  create) 
    minikube start \
      --cpus='8' \
      --disk-size='100g' \
      --driver='hyperkit' \
      --kubernetes-version='stable' \
      --memory='16g' \
      --nodes=1

    # running multiple nodes can have issues with pv permissions
    # https://github.com/kubernetes/minikube/issues/12360

    minikube addons enable ingress

    # Pause until cluster ready?

    # Create Private Certificate Signing Authority
    "$PROJECT_ROOT"/bin/ca

    # Install metrics server
    make -C "${PROJECT_ROOT}/helm/metrics-server" deploy

    ## Install certificate manager
    make -C "${PROJECT_ROOT}/helm/cert-manager" deploy

    ## Install simple nginx app
    # "$PROJECT_ROOT"/bin/cert nginx.minikube.local
    kubectl apply --filename=./manifests/nginx/deployment.yaml
    echo "$(minikube ip) nginx.minikube.local"  | sudo tee -a /etc/hosts

    ## Install Keycloak
    kubectl create ns keycloak
    kubectl apply --filename=./manifests/keycloak/deployment.yaml
    echo "$(minikube ip) keycloak.minikube.local"  | sudo tee -a /etc/hosts

    ## Install Kubernetes Dashboard
    make -C "${PROJECT_ROOT}/helm/kubernetes-dashboard" deploy
    kubectl apply --filename="${PROJECT_ROOT}/helm/kubernetes-dashboard/ingress.yaml"
    echo "$CLUSTER_IP kubernetes-dashboard.minikube.local"  | sudo tee -a /etc/hosts

    ## install operator lifecycle manager
    kubectl apply --filename="${PROJECT_ROOT}/manifests/operator-lifecycle-manager/v0.20.0/crds.yaml"
    kubectl apply --filename="${PROJECT_ROOT}/manifests/operator-lifecycle-manager/v0.20.0/olm.yaml"

    ## Register RedHat Community Operators Source repo
    kubectl apply --filename=manifests/open-data-hub/catalog-source.yaml
    kubectl apply --filename=manifests/open-data-hub/odh-subscription.yaml

    ## create ml-workshop
    kubectl create ns ml-workshop
    kubectl apply --filename=manifests/ml-platform/ml-platform.yaml --namespace ml-workshop

    ;;
  delete|destroy) 
    minikube delete
    ;;
  *)
    echo "unrecognied action"
    exit 0
    ;;
esac


